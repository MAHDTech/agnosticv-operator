---
apiVersion: anarchy.gpte.redhat.com/v1
kind: AnarchyGovernor
metadata:
  name: {{ _name }}
  namespace: anarchy-operator
  resourceVersion: "{{ current_resource_version }}"
spec:
  api: babylon

  parameters:
{% for key in vars.merged_vars if
  key not in vars.merged_vars.__meta__.catalog.parameters | d([]) | json_query('[].name') %}
    {{ key }}: {{ vars.merged_vars[key] | to_json }}
{% endfor %}

  parameterSecrets: {{ vars.merged_vars.__meta__.secrets | default([]) | to_json }}

  vars:
    tower_organization: {{ account | to_json }}

  subjectEventHandlers:
  - event: create
    tasks:
    - name: Set state provision-scheduled in subject status
      anarchy_subject_update:
        metadata:
          labels:
            state: provision-scheduled
        status:
          state: provision-scheduled
    - name: Start Provision
      anarchy_schedule_action:
        action: provision

  - event: update
    tasks:
    - when: >-
        anarchy_subject.spec.desiredState|default('') == 'started' and
        (anarchy_subject.status|default({})).state|default('') == 'stopped'
      block:
      - name: Set state start-scheduled in subject status
        anarchy_subject_update:
          metadata:
            labels:
              state: start-scheduled
          status:
            state: start-scheduled
      - name: Start Resume
        anarchy_schedule_action:
          action: start
    - when: >-
        anarchy_subject.spec.desiredState|default('stopped') == 'stopped' and
        (anarchy_subject.status|default({})).state|default('') == 'started'
      block:
      - name: Set state stop-pending in subject status
        anarchy_subject_update:
          metadata:
            labels:
              state: stop-pending
          status:
            state: stop-pending
      - name: Schedule stop
        anarchy_schedule_action:
          action: stop
  - event: delete
    tasks:
    - name: Schedule destroy
      anarchy_schedule_action:
        action: destroy

  actions:
  - name: provision
    request:
      parameters:
        ACTION: provision
    vars:
      deployer_entry_point: ansible/main.yml
    eventHandlers:
    - event: started
      tasks:
      - name: Set state provisioning in subject status
        anarchy_subject_update:
          metadata:
            labels:
              state: provisioning
          status:
            state: provisioning
    - event: complete
      tasks:
      - name: Set state started in subject status
        anarchy_subject_update:
          metadata:
            labels:
              state: started
          status:
            state: started
{% if 'schedule_stop_after_provision' in merged_vars.__meta__ or 'idle_after_deploy' in merged_vars.__meta__ %}
      - name: Schedule stop
        anarchy_schedule_action:
          action: stop
          after: {{ merged_vars.__meta__.schedule_stop_after_provision | default(merged_vars.__meta__.idle_after_deploy) }}
{% endif %}
{% if 'schedule_destroy_after_provision' in merged_vars.__meta__ %}
      - name: Schedule destroy
        anarchy_schedule_action:
          action: destroy
          after: {{ merged_vars.__meta__.schedule_destroy_after_provision }}
{% endif %}

  - name: stop
    request:
      parameters:
        ACTION: stop
    vars:
      deployer_entry_point: ansible/lifecycle_entry_point.yml
    eventHandlers:
    - event: started
      tasks:
      - name: Set state stopping in subject status
        anarchy_subject_update:
          metadata:
            labels:
              state: stopping
          status:
            state: stopping

      - name: Update desiredState stopped in subject resource handle
        when: >-
          'poolboy.gpte.redhat.com/resource-handle-name' in anarchy_subject.metadata.annotations and
          'poolboy.gpte.redhat.com/resource-handle-namespace' in anarchy_subject.metadata.annotations
        k8s:
          api_version: poolboy.gpte.redhat.com/v1
          kind: ResourceHandle
{% raw %}
          name: >-
            {{ anarchy_subject.metadata.annotations['poolboy.gpte.redhat.com/resource-handle-name'] }}
          namespace: >-
            {{ anarchy_subject.metadata.annotations['poolboy.gpte.redhat.com/resource-handle-namespace'] }}
{% endraw %}
          merge_type: merge
          definition:
            spec:
              template:
                spec:
                  desiredState: stopped
        ignore_errors: true

      - name: Update desiredState stopped in subject resource claim
        when: >-
          'poolboy.gpte.redhat.com/resource-claim-name' in anarchy_subject.metadata.annotations and
          'poolboy.gpte.redhat.com/resource-claim-namespace' in anarchy_subject.metadata.annotations
        k8s:
          api_version: poolboy.gpte.redhat.com/v1
          kind: ResourceClaim
{% raw %}
          name: >-
            {{ anarchy_subject.metadata.annotations['poolboy.gpte.redhat.com/resource-claim-name'] }}
          namespace: >-
            {{ anarchy_subject.metadata.annotations['poolboy.gpte.redhat.com/resource-claim-namespace'] }}
{% endraw %}
          merge_type: merge
          definition:
            spec:
              template:
                spec:
                  desiredState: stopped
        ignore_errors: true

    - event: complete
      tasks:
      - name: Set state stopped in subject status
        anarchy_subject_update:
          metadata:
            labels:
              state: stopped
          status:
            state: stopped

  - name: start
    request:
      parameters:
        ACTION: start
    vars:
      deployer_entry_point: ansible/lifecycle_entry_point.yml
    eventHandlers:
    - event: started
      tasks:
      - name: Set state starting in subject status
        anarchy_subject_update:
          metadata:
            labels:
              state: starting
          status:
            state: starting
    - event: complete
      tasks:
      - name: Set state started in subject status
        anarchy_subject_update:
          metadata:
            labels:
              state: started
          status:
            state: started
{% if 'schedule_stop_after_start' in merged_vars.__meta__ or 'idle_after_start' in merged_vars.__meta__ %}

      - name: Schedule stop
        anarchy_schedule_action:
          action: stop
          after: {{ merged_vars.__meta__.schedule_stop_after_start | default(merged_vars.__meta__.idle_after_start) }}
{% endif %}

  - name: destroy
    request:
      parameters:
        ACTION: destroy
    vars:
      deployer_entry_point: ansible/destroy.yml
    eventHandlers:
    - event: complete
      tasks:
      - name: Delete anarchy subject
        anarchy_subject_delete:
          remove_finalizers: true

      - name: Delete resource handle
        when: >-
          'poolboy.gpte.redhat.com/resource-handle-name' in anarchy_subject.metadata.annotations and
          'poolboy.gpte.redhat.com/resource-handle-namespace' in anarchy_subject.metadata.annotations
        k8s:
          api_version: poolboy.gpte.redhat.com/v1
          kind: ResourceHandle
{% raw %}
          name: >-
            {{ anarchy_subject.metadata.annotations['poolboy.gpte.redhat.com/resource-handle-name'] }}
          namespace: >-
            {{ anarchy_subject.metadata.annotations['poolboy.gpte.redhat.com/resource-handle-namespace'] }}
{% endraw %}
          state: absent
        ignore_errors: true

      - name: Delete resource claim
        when: >-
          'poolboy.gpte.redhat.com/resource-claim-name' in anarchy_subject.metadata.annotations and
          'poolboy.gpte.redhat.com/resource-claim-namespace' in anarchy_subject.metadata.annotations
        k8s:
          api_version: poolboy.gpte.redhat.com/v1
          kind: ResourceClaim
{% raw %}
          name: >-
            {{ anarchy_subject.metadata.annotations['poolboy.gpte.redhat.com/resource-claim-name'] }}
          namespace: >-
            {{ anarchy_subject.metadata.annotations['poolboy.gpte.redhat.com/resource-claim-namespace'] }}
{% endraw %}
          state: absent
        ignore_errors: true
